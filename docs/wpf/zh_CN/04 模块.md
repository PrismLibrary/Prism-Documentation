# 模块

## 使用Prism的WPF库进行模块化应用程序开发

模块化应用程序——可以被分解成一组松散耦合的功能单元（模块），又可以集成到一个更大的应用程序中。客户端模块封装了应用程序全部功能的一部分，典型地表现了一组相关的关系。它可以包含一些相关联的组件，如应用特征；也可以包含用户界面和业务逻辑，或者一部分应用程序的基础结构，如应用级的日志或用户验证。模块之间相互独立但又可以通过一种松散耦合的方式相互通信。使用模块化应用设计模式会使得你的开发，测试，部署和维护更加轻松。

以个人银行业务为例，用户可以在一个界面使用诸多功能，如转账、付款、更新个人信息等。然而，在这些场景背后，每个功能都被封装在独立的模块之中。这些模块借助后端通信系统，如数据库服务或web服务，完成模块间的通信。应用服务集成不同模块的各种类组件并处理和用户之间的通信。终端用户看到就是像一个单独应用的综合视图。

下图就是一个模块化应用的设计示意图。

![Module composition](../images/Ch4ModularityFig1.png)

## 模块化应用优势

你大概正在使用程序集、接口、类和良好的面向对象设计原则来完成一个应用。即使如此，除非非常小心，否则你的应用程序很可能还是会像“一块铁板”一样（所有的功能实现都和应用程序本身紧密耦合），这就会导致应用程序的开发，测试，扩展和维护异常艰难。

模块化应用方法可以帮助你识别程序中存在大量功能的区域，允许你独立地开发和测试这些功能。这可以是开发和测试更简单，除此之外，还可以让你的程序更加灵活，在未来更容易被扩展。正因为模块化应用方法可以让用户将原来的程序分解成容易管理的部分，所以程序的总体架构也就更加灵活，可维护性更强。每个部分都封装特定的功能，每个部分都通过明确且松散耦合的信道集成。

## Prism为模块化应用开发提供的支持

Prism为模块化应用程序开发和运行时模块管理提供帮助。使用Prism可以节省你的时间，因为你不必去实现并测试自己的模块化框架。Prism框架提供如下特性：

- 为注册模块和模块路径提供目录；你可以通过如下途径创建模块目录：
  - 在代码或XAML中定义模块
  - 在指定的目录中加载全部模块
  - 在配置文件中定义
  - 为模块声明元数据属性，以便可以支持初始化模式和依赖性
  - 与依赖注入容器集成以支持模块间的松散耦合
- 模块载入
  - 依赖管理，包括复制和循环检测以保证模块加载顺序正确，保证只加载，初始化一次
  - 模块采用请求式和后台的方式下载，最小化程序启动时间；其余模块的加载和初始化可以在后台或需要的时间进行

## 核心概念

### IModule：模块化程序构件

模块是功能和资源的逻辑集合，为实现独立的开发，测试，部署和集成，它以特定的形式打包。一个程序包可以是一个或多个程序集。每个模块都有一个中心的类，该类负责初始化模块，集成功能至应用。这个中心类实现IModule接口。

注意：实现IModule接口的类的存在已经足够将包识别为模块。
IModule接口有单一的名为Initialize的方法，在方法内部你可以实现任何你所需要的逻辑，并将模块的功能集成到程序之中。取决于模块用途的不同，该接口可以将视图注册到复合的用户界面，为程序创建额外的可用服务，或者扩展程序的功能。下面的代码展示了一个模块的最小化实现。

```c#
public class MyModule : IModule
{
    public void Initialize()
    {
        // Do something here.
    }
}
```

### 模块生命周期

在Prism中模块的装载过程包含以下步骤：

- **注册/发现模块。** 特定应用程序在运行时加载的模块在模块目录中定义。目录包含要装载的模块、模块位置、装载顺序等信息。

- **装载模块。** 包含模块的程序集被载入内存。这个过程可能需要从远程地址或者本地目录重新获得模块。

- **初始化模块。** 初始化模块意味着创建模块类的实例并通过IModule接口调用Initialize方法。

模块装载过程如下图所示。

![Module composition](../images/Ch4ModularityFig2.png)

### 模块目录

模块目录包含可以被程序调用的模块信息。该目录本质上是ModuleInfo类的集合。在ModuleInfo类中描述的模块包含名称、类型、位置以及模块的其他属性。以下是几种使用ModuleInfo实例填充模块目录的典型方法：

- 在代码中注册模块
- 在XAML文件中注册模块
- 在配置文件中注册模块
- 在本地目录注册模块

使用何种注册和发现机制取决于你程序的需要。使用配置文件或者XAML文件的方式可以让你不必引用模块；使用目录的方式可以让你不必指定模块文件。

### 控制何时加载模块

Prism程序可以以最快的速度实现模块——“有条件时”；或者当程序需要时实现模块——“请求式”。考虑以下关于加载模块的指导原则：

- 当程序运行时，保证程序运行所必需的模块一定要随程序一起加载并初始化。
- 当模块可用时，包含程序最经常使用的典型应用特征的模块可用在后台加载并初始化。
- 包含很少使用特征的模块（或者可选择的提供帮助的模块）可以在需要的时候加载。

考虑如何划分应用程序、常见使用场景、应用程序启动时间，以及下载的数量和大小，以确定如何配置您的模块以完成下载和初始化。

### 将模块与应用集成

Prism提供了以下类来引导您的应用程序启动：UnityBootstrapper或MefBootstrapper。这些类可以用来创建和配置模块管理器来发现和加载模块。您可以重写配置方法，使用短短几行代码以注册在XAML文件，配置文件，或发现目录中指定的模块。

使用模块初始化方法将模块与应用程序的其余部分集成。根据应用程序的结构和模块的内容的不同，实现上述方法的途径是多样的。以下是将模块集成到应用程序中的常见事项：

- 将模块的视图添加到应用程序的导航结构中。这在使用视图发现或视图注入构建复合UI应用程序时很常见。
- 订阅应用程序级别的事件或服务。
- 使用应用程序的依赖注入容器注册共享服务。

### 模块之间的通信

尽管模块之间的耦合应该很低，但模块之间的通信还是很常见的。松散耦合的通信模式有几种，每个都有各自的优势。通常，使用这些模式的组合创建解决方案。以下是这些模式：

- **松散耦合的事件。** 模块可以广播某个事件已经发生。其他模块可以订阅这些事件，以便在事件发生时得到通知。松耦合事件是在两个模块之间建立通信的一种轻量级方式；因此，它们很容易实现。然而，过于依赖事件的设计会使得应用程序变得难以维护，特别是当许多事件不得不协同完成一个任务时。在这种情况下，最好考虑共享服务。
- **共享服务。** 共享服务是可以通过公共接口访问的类。通常，共享服务可以在共享程序集中找到，并提供系统范围的服务，例如身份验证、日志记录或配置。
- **共享资源。** 如果您不希望模块之间直接通信，您还可以让它们通过共享资源(比如数据库或一组web服务)进行间接通信。

### 依赖注入和模块化应用程序

像Unity Application Block(Unity)和Managed Extensibility Framework (MEF)这样的容器允许您轻松地使用控制反转(IoC)和依赖注入，这是一种强大的设计模式，有助于以松耦合的方式组合组件。这样组件就可以不必硬编码引用而获取它们所依赖的其他组件，从而提升代码可重用性和灵活性。依赖注入在构建松散耦合的模块化应用程序时非常有用。Prism被设计成对于应用程序中用于组成组件的依赖注入容器是不可知的。容器的选择取决于您，很大程度上取决于您的应用程序需求和首选项。然而，微软有两种主要的依赖注入框架可以考虑- Unity和MEF。

模式与实践Unity Application Block提供了一个功能齐全的依赖注入容器。它支持基于属性和基于构造的注入和策略注入，允许您显式地注入组件之间的行为和策略；它还支持许多典型的依赖注入容器的特性。

MEF(它是.NET Framework 4.5的一部分)通过支持基于依赖注入的组件组合来构建可扩展的.NET应用程序，并提供支持模块化应用程序开发的其他特性。它允许应用程序在运行时发现组件，然后以松耦合的方式将这些组件集成到应用程序中。MEF是一个很好的扩展和组合框架。它包括程序集和类型发现、类型依赖解析、依赖注入，以及一些不错的程序集下载功能。Prism支持利用MEF特性，以及以下内容：

- 通过XAML和代码属性注册模块
- 通过配置文件和目录扫描注册模块
- 在加载模块时的状态跟踪
- 在使用MEF时给模块自定义声明元数据

Unity和MEF依赖注入容器都与Prism无缝地结合。

## 关键决策

你要做的第一个决定是你是否想开发一个模块化的解决方案。如前一节所述，构建模块化应用程序有许多好处，但是您需要花时间和精力来获得这些好处。如果你决定开发一个模块化的解决方案，还有很多事情需要考虑：

- **确定您将使用的框架。** 您可以创建自己的模块化框架，使用Prism、MEF或其他框架。
- **决定如何组织你的解决方案。** 通过定义每个模块的边界，包括每个模块的组成部分，来实现模块化的体系结构。您可以决定使用模块化来简化开发，同时也可以控制应用程序的部署方式，或者它是否支持插件或可扩展的体系结构。
- **确定如何划分模块。** 模块可以根据需求的不同划分成不同的分区，例如功能区域、提供程序的模块、开发团队和部署需求。
- **确定应用程序将提供给所有模块的核心服务。** 例如，核心服务可能是错误报告服务，也可能是身份验证和授权服务。
- **如果您使用Prism，请确定您在模块目录中使用何种方法来注册模块。**  对于WPF而言，您可以在代码、XAML、配置文件中注册模块，或者在磁盘上的本地目录中发现模块。
- **确定模块通信和依赖策略。** 模块需要相互通信，并且您需要处理模块之间的依赖关系。
- **确定依赖注入容器。** 通常，模块化系统需要依赖注入、反转控制或服务定位器，以允许模块的松散耦合，动态加载和创建。Prism允许在使用Unity、MEF或其他容器之间进行选择，并为基于Unity或基于MEF的应用程序提供库支持。
- **减少应用程序的启动时间。** 请考虑模块的按需和后台下载以最小化应用程序启动时间。
- **决定部署需求。** 您需要考虑如何部署应用程序。

下一节将详细介绍以上内容。

## 将应用程序划分成模块

当您以模块化的方式开发应用程序时，您将应用程序构建为独立的客户端模块，这些模块可以单独开发、测试和部署。每个模块将封装应用程序的全部功能的一部分。您需要做的第一个设计决定是如何将应用程序的功能划分为离散的模块。

模块应该封装一组相关的关注点，并有不同的职责。模块可以表示应用程序的垂直部分或水平服务层。大型应用程序可能同时具有两种类型的模块。

![Module composition](../images/Ch4ModularityFig3.png)

由垂直切片的模块组成的应用程序

![Module composition](../images/Ch4ModularityFig4.png)

由水平应用的模块组成的应用程序

一个更大的应用程序可能包含有垂直切片和水平层组织的模块。以下是一些实例：

- 包含特定应用程序特性的模块，如股票交易参考实现中的新闻模块
- 包含一组相关用例的特定子系统或功能的模块，如采购、发票或总账
- 包含基础设施服务的模块，如日志记录、缓存、授权服务或web服务
- 除了其他内部系统之外，包含调用业务系统（LOB）服务的模块，如Siebel CRM和SAP

模块对其他模块的依赖应该最小化。当一个模块依赖于另一个模块时，应该使用共享库中定义的接口，而不是具体类型，或者使用EventAggregator与其他模块通信。

模块化的目标是以一种保持应用程序灵活性、可维护性、稳定性的方式划分应用程序，即使特性和技术不断更迭。实现这一目标的最佳方法是设计应用程序，以便使模块尽可能独立，具有良好定义的接口，并尽可能相互隔离。

### 决定项目与模块之间的比例

有几种创建和打包模块的方法。推荐的并且也是最常用的方法是为每个模块创建一个程序集。这有助于保持逻辑模块的分离，并促进适当的封装。它还使讨论程序集作为模块边界以及如何部署模块的打包更加容易。但是，单个程序集包含多个模块的情况也是存在的，在某些情况下，这可能更倾向于将解决方案中的项目数量最小化。对于一个大型应用程序，拥有10 - 50个模块并不少见。将每个模块分到自己的项目会增加解决方案的复杂性，并会降低Visual Studio的性能。

## 对松散耦合使用依赖注入

模块可能依赖于主应用程序或其他模块提供的组件和服务。Prism支持在模块之间注册依赖的能力，这样它们就可以按照正确的顺序加载和初始化。Prism还支持加载到应用程序中的模块的初始化。在模块初始化过程中，模块可以检索对它所需要的附加组件和服务的引用，并/或注册它所包含的任何组件和服务，以便使它们对于其他模块是可用的。

模块应该使用独立的机制来获取外部接口的实例，而不是直接实例化具体类型，例如使用依赖注入容器或工厂服务。依赖注入容器(如Unity或MEF)允许类型通过依赖注入自动获取接口和类型的实例。Prism集成了Unity和MEF，以允许一个模块轻松地使用依赖注入。

下图显示了加载模块时的典型操作序列，这些模块需要获取或注册对组件和服务的引用。

![Module composition](../images/Ch4ModularityFig5.png)


