# 使用Prism的WPF库构建界面

复合应用程序的用户界面(UI)由被称为视图的松散耦合的可视化组件组成，这些组件通常包含在应用程序的模块中，但其实它们不需要这样做。如果将应用程序划分为模块，则需要某种方法来松散地组合UI，但即使视图不在模块中，也可以选择使用此方法。对于用户来说，应用程序提供了无缝的用户体验，并交付了完整的综合应用程序。

为了构建UI，您需要一个架构，它允许您在运行时创建由松散耦合的视觉元素组成的布局。此外，该架构还应该为这些可视化元素提供以松散耦合的方式进行通信的策略。

应用程序UI可以使用下列范例之一构建：

- 在设计时，表单所必需的控件都应包含在一个可扩展应用程序标记语言(XAML)文件中。
- 表单的逻辑区域应划分为不同、区别明显的部分，通常是用户控件。这些部分由表单引用，并且在设计时编写表单。
- 表单的逻辑区域应划分为不同、区别明显的部分，通常是用户控件。这些部分对表单来说是未知的，并且在运行时动态地添加到窗体中。使用这种方法的应用程序被称为使用UI组合模式的复合应用程序。

股票交易参考实现(股票交易者RI)是由加载的多个视图组成的，这些来自不同模块的视图加载到由shell暴露的区域中，如下图所示。

![Module composition](../images/Ch7UIFig1.png)

# UI布局概念

复合应用程序中的根对象称为shell。shell充当应用程序的主页面。shell包含一个或多个区域。区域是将在运行时加载的内容的占位符。区域附属于UI元素，如ContentControl、ItemsControl、TabControl或自定义控件，并管理UI元素的内容。根据应用程序的要求，可以自动或按需加载区域内容。

通常，一个区域的内容是一个视图。视图封装了您的UI的一部分，并且您希望尽可能地与应用程序的其他部分解耦。您可以将视图定义为用户控件、数据模板，甚至是自定义控件。
区域管理视图的显示和布局。可以使用名称对区域已解耦的方式访问，并支持动态添加或删除视图。一个区域连接到一个托管控件。将区域看作是动态加载视图的容器。

下面几节介绍复合应用程序开发的高级核心概念。

## shell

shell是包含主要UI内容的应用程序根对象。在Windows Presentation Foundation(WPF)应用程序中，shell是窗口对象。

shell扮演一个提供应用程序的布局结构的主页面的角色。shell包含一个或多个命名区域，模块可以指定将要显示在其中的视图。它还可以定义某些顶级UI元素，例如后台、主菜单和工具栏。

shell定义了应用程序的整体外观。它可以定义在shell布局本身中样式和边框的呈现和可见性，它也可以定义样式、模板和主题，这些内容将应用于插入到shell的视图中。

通常，shell是WPF应用程序项目的一部分。包含shell的程序集可能或也可能不引用包含加载在shell区域中的视图的程序集。

## 视图

视图是复合应用程序中UI构造的主要单元。可以将视图定义为用户控件、页面、数据模板或自定义控件。视图封装了一部分您希望尽可能地与应用程序的其他部分解耦的UI。您可以选择基于封装或功能部件加入视图，或者您可以选择定义一些东西作为视图，因为在您的应用程序中，您将拥有该视图的多个实例。

由于WPF的内容模型的存在，因此没有特定的Prism库来定义视图。定义视图最简单的方法是定义一个用户控件。为了向UI添加视图，您只需简单地构造它并将其添加到容器中，WPF提供了这样的机制。Prism库增加了在运行时定义区域，并可以向其中动态添加视图的能力。

## 复合视图

支持特定功能的视图可能变得复杂。在这种情况下，您可能希望将视图划分为多个子视图，并将子视图作为各个部分，使得父视图可以处理自己的构造。应用程序可以在设计时静态地执行以上操作，或者它可以支持现有模块在运行时通过一个包含的区域添加子视图。当您在单个视图类中没有完全定义视图时，可以将其称为复合视图。在许多情况下，复合视图负责构建子视图并协调它们之间的交互。您可以借助Prism库中的命令和事件聚合器来设计更松散耦合的子视图和父视图。

## 视图和设计模式

虽然Prism库不要求您使用它们，但您应该考虑在实现视图时使用几个UI设计模式中的一个。“股票交易”和“QuickStarts ”演示了模型-视图- viewmodel(MVVM)模式，作为实现视图布局和视图逻辑之间的完全分离的途径之一。

推荐使用MVVM UI设计模式，因为它与微软XAML平台是天作之合。这些平台的依赖属性系统和丰富的数据绑定栈使视图和视图模型能够以松散耦合的方式进行通信。

将逻辑从视图中分离对可测试性和可维护性是很重要的，它可以提高开发人员——设计人员之间的工作流的效率。

如果您使用用户控件或自定义控件创建了一个视图，并将所有的逻辑放在后台的代码文件中，那么您的视图可能很难测试，因为您必须创建一个视图的实例来对逻辑进行单元测试。这样就带来了一个问题，特别是如果视图源自或依赖于运行WPF组件作为其执行上下文的一部分。为了确保可以在没有这些依赖项的情况下独立地对视图逻辑进行单元测试，您需要能够创建视图的模型，以消除对执行上下文中的依赖，这需要对视图和逻辑而言相对独立的类。

如果将视图定义为数据模板，这样就不存在与视图本身相关的代码。因此，您必须在其他地方放置相关的逻辑。将逻辑完全地从布局中分离出来以提高可测试性，同样，这也有助于使视图更易于维护。

注意：单元测试和UI自动化测试是两种有着不同覆盖范围，不同类型的测试。

单元测试的最优方法建议对对象进行独立地测试。为了实现对象之间的隔离，需要对每个外部依赖项建立一个模型或存根。然后对对象进行细粒度的单元测试。

UI自动化测试运行应用程序，将手势应用于UI，然后测试预期结果。这种类型的测试验证UI元素是否正确连接到应用程序逻辑。

将逻辑与视图分离使得它们之间的关系更明晰。除了可测试性考虑之外，这种分离使设计人员能够独立于开发人员在UI上工作。有关MVVM的更多信息，请参见实现MVVM模式。

## 命令，UI触发器，动作和行为

当在后台代码文件中实现视图的逻辑时，您可以添加事件处理程序来服务UI交互。然而，当您使用MVVM时，视图模型不能直接处理由UI引发的事件。要将UI手势事件发送到视图模型，您可以使用命令或UI触发器、操作和行为。

### 命令
命令从执行命令的逻辑中分离出调用命令的语义和对象。内置命令有能力指示动作是否可用。UI中的命令是绑定到视图模型上的ICommand属性的数据。有关命令的更多信息，请参见实现MVVM模式的命令。

### UI触发器，动作和行为

触发器、动作和行为都是Microsoft.Expression.Interactivity的一部分，并且随Blend for Visual Studio 2013一同发布。它们也是Blend SDK的一部分。触发器、动作和行为为处理UI事件或命令提供了一个全面的API，然后将它们路由到由DataContext公开的ICommand属性方法。有关UI触发器、操作和行为的更多信息，请参阅在高级MVVM场景中实现MVVM模式、交互触发器和事件的部分。

### 用户交互

用户交互是应用程序向用户呈现的交互。这些交互是典型的呈现给用户的弹出窗口。在MVVM场景中，可以从视图或视图模型生成这些用户交互。当视图模型需要请求用户交互时，Prism为用例提供InteractionRequests和InteractionRequestTriggers，以及当指定的事件被触发视图需要调用命令时，提供InvokeCommandAction。
有关用户交互、示例以及如何使用的更多信息，请参见交互性快速启动。

## 数据绑定

数据绑定是XAML平台最重要的框架特性之一。要成功地在XAML平台上开发应用程序，您需要对数据绑定有一个全面的理解。

数据绑定充分利用由依赖属性系统提供的内部更改通知的特性。当与INotifyPropertyChanged接口的公共语言运行时(CLR)类实现结合在一起时，更改通知可以实现参与数据绑定的目标对象和源对象之间的无代码交互。

数据绑定通过使用一个值转换器将一个类型转换为另一种类型，从而使不同类型的目标和源实现数据绑定。数据绑定在其管道中有多个验证钩子函数，可以用来验证用户输入。

强烈建议您阅读MSDN上的依赖性属性概述和数据绑定概述主题。充分了解这两个主题对于成功地在Microsoft XAML平台上开发应用程序至关重要。有关数据绑定的更多信息，请参见实现MVVM模式的数据绑定。

## 区域

通过区域管理器、区域和区域适配器在Prism库中启用区域。下一节将介绍它们是如何一起工作的。

### 区域管理器

区域管理器类负责创建和维护宿主控件中的区域集合。区域管理器使用一个控制特定的适配器与新区域的宿主控件关联起来。下图显示区由域管理器设置的区域、控件和适配器之间的关系。

![Module composition](../images/Ch7UIFig2.png)

区域管理器可以在代码或XAML中创建区域。附近属性RegionManager RegionName通过将属性附加到宿主控件，在XAML中创建一个区域。

应用程序可以包含区域管理器的一个或多个实例。您可以指定要注册该区域的区域管理器实例。如果您想在可视树中移动控件，并且不希望在附加属性被删除时清除该区域，这将非常有用。

区域管理器提供了一个区域上下文附加属性，允许其区域共享数据。

### 区域实现

区域实现了IRegion接口。术语区域表示一个容器，它可以保存在UI中呈现的动态数据。区域允许Prism库将包含在模块中的动态内容放置在UI容器中的预定义占位符中。

区域可以容纳任何类型的UI内容。一个模块可以包含作为用户控件的UI内容，与数据模板相关联的数据类型，自定义控件，或者这些的任何组合。这允许您定义UI区域的外观，然后在这些预先确定的区域中让模块放置内容。

一个区域可以包含零个或更多项。根据区域管理器正在管理的宿主控件类型，一个或多个项可以被设置为可见。例如，一个ContentControl可以只显示一个对象。然而，它所在的区域可以包含许多项，并且ItemsControl可以显示多个项。这允许该区域中的每个项在UI中都是可见的。

在下图中，股票交易追踪系统的界面包含四个区域：MainRegion、MainToolbarRegion、ResearchRegion和ActionRegion。这些区域由应用程序中的各个模块填充，内容可以随时更改。

![Module composition](../images/Ch7UIFig3.png)

## 模块中用户控件到区域的映射

为了演示模块和内容是如何与区域关联的，请参见下面的插图。它显示了WatchModule和NewsModule与shell中相应区域的关联。

主区域包含WatchListView用户控件，该控件包含在WatchModule中。ResearchRegion还包含了ArticleView用户控件，它包含在NewsModule中。

在由Prism库创建的应用程序中，像这样的映射将是设计过程的一部分，因为设计者和开发人员使用它们来确定在特定区域中将要用到的内容。这允许设计人员确定所需的总体空间，以及必须添加的任何额外项，以确保内容在可容空间中是可见的。

![Module composition](../images/Ch7UIFig4.png)

## 默认区域功能

当你要使用区域，但又不需要完全理解其实现时，理解控件与区域之间是如何相关联的和默认区域功能就可能会非常有帮助：例如，区域如何定位和实例化视图，活动视图如何获取通知，或如何激活视图的生命周期。

下面的部分描述了区域适配器和区域行为。

## 区域适配器

要将UI控件公开为区域，它必须有一个区域适配器。区域适配器负责创建一个区域并将其与控件相关联。这允许您使用IRegion接口以一致的方式管理UI控件内容。每个区域适配器都适应一种特定类型的UI控件。Prism库提供以下三个区域适配器：

- **ContentControlRegionAdapter。**
这类适配器适应于System.Windows.Controls.ContentControl及其派生类。
- **SelectorRegionAdapter。**
这类适配器适应于由System.Windows.Controls.Primitives.Selector派生的控件，如System.Windows.Controls.TabControl控件。
- **ItemsControlRegionAdapter。**
这类适配器适应于System.Windows.Controls.ItemsControl及其派生类的控件。

## 区域行为
Prism库引入了区域行为的概念。这些都是可插拔的组件，实现了区域的大部分功能。区域行为被引入以支持视图发现和区域上下文(后文描述)，并创建一个跨WPF和Silverlight的一致的API。此外，行为提供了扩展区域实现的有效方法。

区域行为是一个附加到区域的类，以赋予该区域额外的功能。这种行为依附于该区域，并在该区域的生命周期中保持活跃。















